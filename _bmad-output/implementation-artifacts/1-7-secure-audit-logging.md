# Story 1.7: secure-audit-logging

Status: ready-for-dev

## Story

As a system administrator,
I want the system to maintain a secure, immutable audit log of all access to electronic Protected Health Information (ePHI),
so that I can track and verify compliance with security regulations.

## Acceptance Criteria

1. **Given** any user accesses or modifies ePHI within the system,
2. **When** the action occurs,
3. **Then** an entry is automatically recorded in an immutable audit log.
4. **And** the log entry includes the user's identity, the action performed, the timestamp, and the specific ePHI accessed or modified.
5. **And** the audit log is protected from unauthorized modification or deletion.
6. **And** the audit log viewing interface utilizes the default header and sidebar
## Tasks / Subtasks

- [ ] **Database & Schema Configuration**
  - [ ] Add the `audit_logs` table to `src/lib/db/schema.ts` strictly matching the schema defined in the architecture.
  - [ ] Ensure the schema uses `id` (UUID PK), `actor_user_id` (UUID FK), `action` (TEXT), `resource_type` (TEXT), `resource_id` (UUID), `details` (JSONB), `ip_address` (TEXT), `user_agent` (TEXT), and `occurred_at` (TIMESTAMPTZ DEFAULT NOW()).
  - [ ] Generate and apply the Drizzle database migration.
- [ ] **Context & Metadata Capture**
  - [ ] Update the tRPC context in `src/server/context.ts` to extract and expose the `ip_address` (e.g., via `x-forwarded-for` headers) and `user_agent` from the incoming Next.js request.
- [ ] **Audit Logging Service/Middleware**
  - [ ] Create a reusable audit logging utility or tRPC middleware (e.g., `src/server/services/audit.ts` or within `src/server/trpc.ts`) that accepts the action, resource type, resource ID, and details.
  - [ ] Ensure this utility automatically pulls the `actor_user_id`, `ip_address`, and `user_agent` from the tRPC context to construct the log entry.
  - [ ] **Immutability Enforcement:** Ensure this service ONLY uses Drizzle `insert` commands. Do not write or expose any functions or tRPC procedures that allow `update` or `delete` operations on the `audit_logs` table.
- [ ] **Integration (Proof of Concept)**
  - [ ] Integrate the new audit logging utility into at least one existing sensitive endpoint (e.g., retrieving user profile data or updating staff in `staffRouter` or `adminRouter`) to prove ePHI access/modification tracking works.
- [ ] **Frontend Viewer UI**
  - [ ] Create the Audit Log viewing page for administrators.
  - [ ] Wrap the page layout with the application's default header and sidebar components.

## Dev Notes

### üèóÔ∏è Architecture & Security Constraints (CRITICAL)
- **Database Mapping:** You must implement the table exactly as specified in Epic 1's architecture schema. The `occurred_at` timestamp must be generated by the database (`DEFAULT NOW()`) to ensure immutability at the source.
- **Request Context:** You will need to carefully modify `src/server/context.ts` to parse request headers. Next.js App Router exposes headers in route handlers, which can be passed into the `createContext` function.
- **Append-Only:** The definition of "immutable" at the application layer means your code should physically lack the ability to update or delete rows in the `audit_logs` table. No tRPC mutations should exist for altering these logs.
- **UI Architecture:** The frontend must strictly adhere to the requested layout. Use the shared layout components for the header and sidebar, and explicitly utilize the `google stitch mcp server` for populating the main container of the audit logs view.

### üí° Intelligence from Previous Stories
- RBAC is already firmly established using custom tRPC middlewares (e.g., `adminProcedure`, `doctorProcedure`) in `src/server/trpc.ts`. Leverage the existing `ctx.user` object to populate the `actor_user_id`.
- Drizzle ORM is used for all database interactions. Use the existing patterns found in `src/server/routers/admin.ts` or `src/server/routers/staff.ts` for database inserts.

### Project Structure Notes
- **Schema:** `src/lib/db/schema.ts`
- **Context:** `src/server/context.ts`
- **Core Logic:** `src/server/services/audit.ts` (Recommended new file for the reusable logging logic to keep routers clean).
- **Frontend Page:** `src/app/admin/audit-logs/page.tsx` 

### References
- Database Schema Guidelines: [Source: architecture.md#Appendix A: Detailed Database Schema]
- Requirement Epics: [Source: epics.md#Story 1.7: Secure Audit Logging]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List